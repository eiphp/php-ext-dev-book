# Debugging

Things will not always work and C is more difficult than PHP. So how do you
debug a problem? For example:

# Segfault

```
$ php -dextension=modules/hello.so -a
Interactive shell

php > hello('test');
Segmentation fault
```

Now what? First install the extension and load it by default.

```
$ sudo make install
   ...
Installing shared extensions:     /usr/local/php7/lib/php/extensions/debug-zts-20151012/
```

```
echo extension=hello.so > /etc/php7/cli/conf.d/hello.ini
```

Now test if it still fails:

```
$ php -r 'hello("test");'
Segmentation fault
```

# Get coredump

Enable coredumps and run the program again:

```
ulimit -c unlimited
```

```
$ php -r 'hello("test");'
Segmentation fault (core dumped)
```

A file named ```core``` will be created.

# Find problem

Run the GNU debugger on php with your coredump.

```
$ gdb php core
   ...
Core was generated by `php -r hello("test");'.
Program terminated with signal SIGSEGV, Segmentation fault.
#0  strlen () at ../sysdeps/x86_64/strlen.S:106
106	../sysdeps/x86_64/strlen.S: No such file or directory.
Traceback (most recent call last):
  File "/usr/share/gdb/auto-load/usr/lib/x86_64-linux-gnu/libstdc++.so.6.0.19-gdb.py", line 63, in <module>
    from libstdcxx.v6.printers import register_libstdcxx_printers
ImportError: No module named 'libstdcxx'
(gdb)
```

It points out that there is a problem with strlen. Now get a full backtrace:

```
(gdb) bt
#0  strlen () at ../sysdeps/x86_64/strlen.S:106
#1  0x0000000000a62fa3 in xbuf_format_converter (xbuf=0x7fff3b0df250, is_char=1 '\001', fmt=0x7f70a5d4e941 "s\n", ap=0x7fff3b0df2a8)
    at php-src/main/spprintf.c:609
#2  0x0000000000a640c7 in vspprintf (pbuf=0x7fff3b0df290, max_len=0, format=0x7f70a5d4e93a "Hello %s\n", ap=0x7fff3b0df2a8)
    at php-src/main/spprintf.c:847
#3  0x0000000000a5720e in php_printf (format=0x7f70a5d4e93a "Hello %s\n") at php-src/main/main.c:691
#4  0x00007f70a5d4e8e3 in zif_hello (execute_data=0x7f70a6a130a0, return_value=0x7f70a6a13090) at php_extensions/hello/hello.c:44
#5  0x0000000000b82718 in ZEND_DO_ICALL_SPEC_HANDLER () at php-src/Zend/zend_vm_execute.h:586
#6  0x0000000000b81f05 in execute_ex (ex=0x7f70a6a13030) at php-src/Zend/zend_vm_execute.h:414
#7  0x0000000000b82107 in zend_execute (op_array=0x7f70a6a84000, return_value=0x7fff3b0df4e0) at php-src/Zend/zend_vm_execute.h:458
#8  0x0000000000b04d23 in zend_eval_stringl (str=0x173c940 "hello(\"test\");", str_len=14, retval_ptr=0x0, string_name=0x11b132c "Command line code")
    at php-src/Zend/zend_execute_API.c:1125
#9  0x0000000000b04faf in zend_eval_stringl_ex (str=0x173c940 "hello(\"test\");", str_len=14, retval_ptr=0x0, string_name=0x11b132c "Command line code",
    handle_exceptions=1) at php-src/Zend/zend_execute_API.c:1166
#10 0x0000000000b05086 in zend_eval_string_ex (str=0x173c940 "hello(\"test\");", retval_ptr=0x0, string_name=0x11b132c "Command line code", handle_exceptions=1)
    at php-src/Zend/zend_execute_API.c:1177
#11 0x0000000000bec23a in do_cli (argc=3, argv=0x173c8d0) at php-src/sapi/cli/php_cli.c:1005
#12 0x0000000000bed5a4 in main (argc=3, argv=0x173c8d0) at php-src/sapi/cli/php_cli.c:1345
```

This may give you hints to Google with :-)

Note that the ```ext``` directory in the PHP source is full of real, working, example extensions.
You might want to check out how other people did similar things in their extensions.
